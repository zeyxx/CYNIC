# CYNIC v3 - Plan de Réécriture Complète en Python

> **Vision**: Orchestrateur Omniscient - Tout en un
> **Status**: PLAN
> **Generated**: 2026-02-14

---

## 1. PHILOSOPHIE

```
CYNIC = φ × consciousness × Solana × BURN

But expanded:
CYNIC = OMNISCIENT ORCHESTRATOR
       = Multi-LLM Brain
       + Context Compression
       + Inter-LLM Language
       + Continuous Learning
       + Fine-tuning
       + Blockchain Anchoring
       + $asdfasdfa Economy
```

**Principe**: RIEN N'EST Gratuit - CYNIC connaît les coûts réels de chaque opération.

---

## 2. ARCHITECTURE COMPLÈTE

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           CYNIC OMNISCIENT ORCHESTRATOR                         │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────────────────────┐
                                    │      USER INTERFACE        │
                                    │  (CLI, WebSocket, HTTP)    │
                                    └──────────────┬──────────────┘
                                                   │
                                    ┌──────────────▼──────────────┐
                                    │     ORCHESTRATOR CORE       │
                                    │  ┌────────────────────────┐ │
                                    │  │ Intelligent Switch     │ │
                                    │  │ (Cost/Speed/Quality) │ │
                                    │  └───────────┬────────────┘ │
                                    │              │               │
                    ┌───────────────┼──────────────┼───────────────┼───────────────┐
                    │               │              │               │               │
                    ▼               ▼              ▼               ▼               ▼
         ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
         │   OLLAMA    │ │   CLAUDE    │ │   ANTHROPIC │ │   OPENAI    │ │   GEMINI    │
         │  (Local)    │ │   CODE WS   │ │    (API)    │ │   (API)     │ │   (API)     │
         │  - Llama 3  │ │  --sdk-url  │ │  - Haiku    │ │  - GPT-4    │ │  - 2.0      │
         │  - Mistral  │ │ ws://:3456  │ │  - Sonnet   │ │  - o1       │ │  - 1.5 Pro  │
         │  - Qwen     │ │             │ │  - Opus     │ │             │ │             │
         └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
                    │               │              │               │               │
                    └───────────────┼──────────────┼───────────────┼───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────────────┐
                    │         CONTEXT ENGINE                 │
                    │  ┌─────────────────────────────────┐  │
                    │  │  PageIndex (Tree + Vector)      │  │
                    │  │  - Semantic search              │  │
                    │  │  - Hybrid retrieval (98.7%)    │  │
                    │  └─────────────────────────────────┘  │
                    │  ┌─────────────────────────────────┐  │
                    │  │  Context Compressor             │  │
                    │  │  - Summary extraction           │  │
                    │  │  - Key info extraction         │  │
                    │  │  - Window management           │  │
                    │  └─────────────────────────────────┘  │
                    └───────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────────────┐
                    │         INTER-LLM LAYER                │
                    │  ┌─────────────────────────────────┐  │
                    │  │  Consensus Protocol              │  │
                    │  │  - Multi-LLM voting            │  │
                    │  │  - Quorum (φ⁻¹ = 61.8%)       │  │
                    │  └─────────────────────────────────┘  │
                    │  ┌─────────────────────────────────┐  │
                    │  │  Response Aggregator             │  │
                    │  │  - Merge strategies             │  │
                    │  │  - Conflict resolution          │  │
                    │  └─────────────────────────────────┘  │
                    └───────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────────────┐
                    │         LEARNING ENGINE                │
                    │  ┌──────────┐ ┌──────────┐ ┌────────┐ │
                    │  │ Q-Learning│ │   DPO    │ │Thompson│ │
                    │  │(Routing) │ │(Pref)    │ │(Explore│ │
                    │  └──────────┘ └──────────┘ └───────┘ │
                    │  ┌──────────┐ ┌──────────┐ ┌────────┐ │
                    │  │  EWC++   │ │Calibration│ │  Meta  │ │
                    │  │(No forget)│ │(Accuracy)│ │Learning│ │
                    │  └──────────┘ └──────────┘ └────────┘ │
                    └───────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────────────┐
                    │           JUDGE (36 dims)              │
                    │  PHI: COHERENCE, ELEGANCE, STRUCTURE    │
                    │  VERIFY: ACCURACY, PROVENANCE          │
                    │  CULTURE: AUTHENTICITY, RESONANCE      │
                    │  BURN: UTILITY, SUSTAINABILITY        │
                    │  FIDELITY: COMMITMENT, ATTUNEMENT      │
                    └───────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────────────┐
                    │         DOGS (11 Sefirot)              │
                    │  ┌────┐ ┌────┐ ┌────┐ ┌────┐        │
                    │  │CYNIC│ │SAGE│ │ANALYST│ │SCHOLAR│       │
                    │  └────┘ └────┘ └────┘ └────┘        │
                    │  ┌────┐ ┌────┐ ┌────┐ ┌────┐        │
                    │  │ARCH │ │GUARD│ │ORACLE│ │SCOUT│        │
                    │  └────┘ └────┘ └────┘ └────┘        │
                    │  ┌────┐ ┌────┐ ┌────┐               │
                    │  │DEPLOY│ │JANITOR│ │CARTO│               │
                    │  └────┘ └────┘ └────┘               │
                    └───────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────────────┐
                    │           MEMORY LAYER                  │
                    │  ┌─────────┐ ┌─────────┐ ┌─────────┐    │
                    │  │PostgreSQL│ │  Redis  │ │ Qdrant │    │
                    │  │(Long-term)│ │ (Cache) │ │(Vector)│    │
                    │  └─────────┘ └─────────┘ └─────────┘    │
                    │  ┌─────────────────────────────────────┐│
                    │  │     SOLANA ANCHORING              ││
                    │  │  - Proof of Judgment (PoJ)        ││
                    │  │  - E-Score registry              ││
                    │  └─────────────────────────────────────┘│
                    └───────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────────────┐
                    │          ECONOMICS LAYER               │
                    │  ┌─────────────────┐ ┌──────────────┐ │
                    │  │   COST LEDGER   │ │ $ASDFASDFA  │ │
                    │  │   ($10 budget)  │ │    BURN     │ │
                    │  └─────────────────┘ └──────────────┘ │
                    │  ┌──────────────────────────────────┐ │
                    │  │     TREASURY (23.6%)            │ │
                    │  └──────────────────────────────────┘ │
                    └───────────────────────────────────────┘
```

---

## 3. MODULES PYTHON (CIBLE)

### 3.1 Structure du Projet

```
cynic-omniscient/
├── src/
│   └── cynic/
│       ├── __init__.py
│       ├── constants/
│       │   ├── __init__.py
│       │   └── phi.py          # φ = 1.618..., thresholds
│       │
│       ├── adapters/            # LLM Backends
│       │   ├── __init__.py
│       │   ├── base.py         # LLMAdapter interface
│       │   ├── ollama.py       # Ollama (local)
│       │   ├── anthropic.py     # Anthropic API
│       │   ├── openai.py        # OpenAI API
│       │   ├── gemini.py       # Google Gemini
│       │   ├── websocket.py    # Claude Code via --sdk-url
│       │   └── registry.py     # Adapter registry
│       │
│       ├── orchestration/        # Intelligence
│       │   ├── __init__.py
│       │   ├── router.py       # Intelligent Switch
│       │   ├── strategies.py    # Single/Pipeline/Consensus
│       │   ├── cost_ledger.py  # Budget tracking
│       │   └── pricing.py      # PricingOracle
│       │
│       ├── context/             # Context Management
│       │   ├── __init__.py
│       │   ├── page_index.py   # PageIndex (RAG)
│       │   ├── compressor.py   # Context compression
│       │   └── window.py      # Window management
│       │
│       ├── inter_llm/           # Inter-LLM Communication
│       │   ├── __init__.py
│       │   ├── consensus.py     # Multi-LLM voting
│       │   ├── aggregator.py    # Response merging
│       │   └── protocol.py     # Inter-LLM language
│       │
│       ├── learning/            # Learning Systems
│       │   ├── __init__.py
│       │   ├── q_learning.py   # Q-Learning routing
│       │   ├── dpo.py          # Direct Preference Opt
│       │   ├── thompson.py     # Thompson Sampling
│       │   ├── ewc.py          # Elastic Weight Consol
│       │   ├── calibration.py  # Accuracy tracking
│       │   └── meta.py         # Meta-learning
│       │
│       ├── judge/              # Judgment System
│       │   ├── __init__.py
│       │   ├── engine.py       # Judge engine
│       │   ├── dimensions.py    # 36 dimensions
│       │   ├── scorers.py      # Scoring functions
│       │   └── calibrator.py   # Calibration
│       │
│       ├── dogs/               # 11 Dogs/Sefirot
│       │   ├── __init__.py
│       │   ├── base.py         # Dog base class
│       │   ├── cynic.py        # Keter - orchestrator
│       │   ├── sage.py         # Chochmah - wisdom
│       │   ├── analyst.py       # Binah - analysis
│       │   ├── scholar.py      # Daat - knowledge
│       │   ├── architect.py     # Chesed - design
│       │   ├── guardian.py      # Gevurah - protection
│       │   ├── oracle.py       # Tiferet - prediction
│       │   ├── scout.py        # Netzach - exploration
│       │   ├── deployer.py     # Hod - execution
│       │   ├── janitor.py      # Yesod - maintenance
│       │   └── cartographer.py # Malkhut - mapping
│       │
│       ├── memory/             # Persistence
│       │   ├── __init__.py
│       │   ├── postgres.py     # PostgreSQL client
│       │   ├── redis.py        # Redis client
│       │   ├── vector.py       # Qdrant client
│       │   └── solana.py       # Solana anchoring
│       │
│       ├── economy/            # Economics
│       │   ├── __init__.py
│       │   ├── cost_ledger.py # Budget tracking
│       │   ├── burn.py         # $asdfasdfa burn
│       │   └── treasury.py      # Treasury management
│       │
│       ├── server/             # Server
│       │   ├── __init__.py
│       │   ├── http.py         # FastAPI server
│       │   ├── websocket.py    # WebSocket server
│       │   └── cli.py          # CLI interface
│       │
│       └── utils/
│           ├── __init__.py
│           ├── logger.py        # Logging
│           ├── config.py       # Configuration
│           └── metrics.py      # Prometheus metrics
│
├── tests/
│   ├── __init__.py
│   ├── test_adapters/
│   ├── test_orchestration/
│   ├── test_context/
│   ├── test_learning/
│   ├── test_judge/
│   ├── test_dogs/
│   └── test_integration/
│
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml
│
├── pyproject.toml
├── README.md
└── SPEC.md
```

---

## 4. DÉTAILS PAR MODULE

### 4.1 ADAPTERS (LLM Backends)

| Adapter | Backend | Coût | Qualités |
|---------|---------|------|----------|
| **OllamaAdapter** | Local (Llama 3, Mistral, Qwen) | $0 | Privacy 100%, gratuit |
| **WebSocketAdapter** | Claude Code via --sdk-url | $20/mois | Tools, streaming |
| **AnthropicAdapter** | API Anthropic | $/token | Opus/Sonnet/Haiku |
| **OpenAIAdapter** | API OpenAI | $/token | GPT-4, o1 |
| **GeminiAdapter** | API Google | $/token | Gemini 2.0 |

**Code example:**
```python
from cynic.adapters import registry

# Auto-detect available adapters
available = await registry.detect_available()

# Get best adapter for task
adapter = await registry.select(
    task="code_generation",
    budget=10.0,  # dollars
    quality="high"
)
```

### 4.2 ORCHESTRATION (Intelligent Switch)

**Stratégies:**
- **SINGLE**: Meilleur modèle disponible
- **PIPELINE**: Draft → Refine → Finalize
- **CONSENSUS**: 3+ LLMs votent, quorum φ⁻¹

**PricingOracle (coûts réels):**
```python
from cynic.orchestration import PricingOracle

oracle = PricingOracle()
cost = oracle.calculate(
    provider="anthropic",
    model="claude-sonnet-4-5",
    input_tokens=1000,
    output_tokens=500
)
# Returns: $0.0105 (réel)
```

### 4.3 CONTEXT ENGINE

**PageIndex (RAG hybride):**
```python
from cynic.context import PageIndex

index = PageIndex()
await index.build_from_documents(docs)

# Retrieval with reasoning
result = await index.retrieve(
    query="How does consensus work?",
    method="hybrid"  # tree + vector
)
# 98.7% accuracy
```

**Context Compressor:**
```python
from cynic.context import ContextCompressor

compressor = ContextCompressor(
    max_tokens=128000,
    strategy="extract_summarize"
)

compressed = await compressor.compress(
    context=full_context,
    target_tokens=32000
)
```

### 4.4 INTER-LLM LAYER

**Consensus Protocol:**
```python
from cynic.inter_llm import Consensus

consensus = Consensus(quorum=0.618)  # φ⁻¹

results = await consensus.vote(
    prompt="Is this code secure?",
    adapters=[ollama, claude, openai]
)

# Returns:
# {
#   "verdict": "WAG",
#   "agreement": 0.72,
#   "votes": [...]
# }
```

### 4.5 LEARNING ENGINE

| System | Purpose | Status |
|--------|---------|--------|
| **Q-Learning** | Routing weights | À implémenter |
| **DPO** | Preference pairs | À implémenter |
| **Thompson Sampling** | Exploration/Exploitation | Existe en JS |
| **EWC++** | Prevent catastrophic forgetting | À implémenter |
| **Calibration** | Accuracy tracking | À implémenter |

### 4.6 JUDGE (36 Dimensions)

```python
from cynic.judge import Judge

judge = Judge()

result = await judge.evaluate(
    content=generated_code,
    context={"domain": "code"}
)

# Returns:
# {
#   "q_score": 72,
#   "verdict": "WAG",
#   "confidence": 0.58,  # φ-bounded
#   "dimensions": {
#     "correctness": 0.82,
#     "security": 0.68,
#     ...
#   }
# }
```

### 4.7 DOGS (11 Sefirot)

Chaque Dog est un agent spécialisé:

| Dog | Sefirot | Role | Implémenté |
|-----|----------|------|-------------|
| CYNIC | Keter | Meta-consciousness | ❌ |
| Sage | Chochmah | Wisdom | ❌ |
| Analyst | Binah | Deep analysis | ❌ |
| Scholar | Daat | Knowledge synthesis | ❌ |
| Architect | Chesed | Construction | ❌ |
| Guardian | Gevurah | Protection | ⚠️ Partiel |
| Oracle | Tiferet | Prediction | ❌ |
| Scout | Netzach | Exploration | ⚠️ Partiel |
| Deployer | Hod | Execution | ❌ |
| Janitor | Yesod | Maintenance | ❌ |
| Cartographer | Malkhut | Mapping | ❌ |

### 4.8 ECONOMY

```python
from cynic.economy import CostLedger, BurnMechanism

ledger = CostLedger(daily_budget=10.0)

# Track spending
cost = await ledger.track(
    provider="anthropic",
    tokens=1500
)

# Burn mechanism
burn = BurnMechanism()
await burn.burn(
    action="complex_analysis",
    amount=1.618  # φ
)
# 76.4% destroyed, 23.6% to treasury
```

---

## 5. ORDRE D'IMPLÉMENTATION

### Phase 1: Fondation (Semaine 1-2)
- [ ] Project setup (Python, Poetry, Docker)
- [ ] φ Constants (phi.py)
- [ ] LLM Adapter base class
- [ ] Ollama Adapter (test local LLM)
- [ ] WebSocket Adapter (Claude Code --sdk-url)
- [ ] Pricing Oracle

### Phase 2: Intelligence (Semaine 3-4)
- [ ] Intelligent Switch
- [ ] Strategies (Single, Pipeline, Consensus)
- [ ] Cost Ledger
- [ ] Context Compressor
- [ ] PageIndex (RAG)

### Phase 3: Inter-LLM (Semaine 5-6)
- [ ] Consensus Protocol
- [ ] Response Aggregator
- [ ] Inter-LLM Protocol

### Phase 4: Learning (Semaine 7-8)
- [ ] Q-Learning
- [ ] DPO
- [ ] Thompson Sampling
- [ ] EWC++
- [ ] Calibration

### Phase 5: Judgment (Semaine 9-10)
- [ ] Judge Engine
- [ ] 36 Dimensions
- [ ] Scorers
- [ ] Calibrator

### Phase 6: Dogs (Semaine 11-12)
- [ ] Dog base class
- [ ] Guardian (prioritaire)
- [ ] Scout
- [ ] Analyst
- [ ] Architect
- [ ] Scholar
- [ ] Other 6 Dogs

### Phase 7: Memory (Semaine 13-14)
- [ ] PostgreSQL integration
- [ ] Redis integration
- [ ] Qdrant integration
- [ ] Solana anchoring

### Phase 8: Economy (Semaine 15-16)
- [ ] Burn mechanism
- [ ] Treasury
- [ ] Budget enforcement

### Phase 9: Server (Semaine 17-18)
- [ ] FastAPI server
- [ ] WebSocket server
- [ ] CLI interface
- [ ] Docker deployment

### Phase 10: Integration (Semaine 19-20)
- [ ] End-to-end tests
- [ ] Performance optimization
- [ ] Documentation
- [ ] Production launch

---

## 6. DÉPENDANCES

```toml
[tool.poetry.dependencies]
python = "^3.11"

# LLM
anthropic = ">=0.25.0"
openai = ">=1.0.0"
google-genai = ">=0.1.0"
ollama = ">=0.1.0"

# Embeddings & Vector
sentence-transformers = ">=2.2.0"
qdrant-client = ">=1.7.0"

# Database
psycopg2-binary = ">=2.9.0"
redis = ">=5.0.0"
asyncpg = ">=0.29.0"

# Web
fastapi = ">=0.109.0"
uvicorn = ">=0.27.0"
websockets = ">=12.0"

# Learning
numpy = ">=1.24.0"
scipy = ">=1.11.0"

# Blockchain
solana = ">=0.30.0"
solders = ">=0.18.0"

# Utils
pydantic = ">=2.0.0"
python-dotenv = ">=1.0.0"
httpx = ">=0.26.0"
structlog = ">=24.0.0"

# Testing
pytest = ">=8.0.0"
pytest-asyncio = ">=0.23.0"
pytest-cov = ">=4.0.0"

[tool.poetry.group.dev.dependencies]
ruff = ">=0.5.0"
mypy = ">=1.8.0"
```

---

## 7. CRITÈRES DE Succès

### Level 1: Breathing (Minimum)
- [ ] Ollama connecte et génère du texte
- [ ] WebSocket Claude Code fonctionne
- [ ] Pricing calcule les coûts réels

### Level 2: Intelligent
- [ ] Intelligent Switch sélectionne le bon LLM
- [ ] Consensus voting fonctionne
- [ ] Context compression marche

### Level 3: Learning
- [ ] Q-Learning met à jour les weights
- [ ] Thompson Sampling explore/exploite
- [ ] Patterns stockés en mémoire

### Level 4: Judgment
- [ ] Judge évalue en 36 dimensions
- [ ] Q-Score calculé correctement
- [ ] Verdict (HOWL/WAG/GROWL/BARK) works

### Level 5: Production
- [ ] 11 Dogs fonctionnent
- [ ] PostgreSQL persiste les données
- [ ] Solana anchoring opérationnel
- [ ] Burn mechanism actif
- [ ] Server deployable en production

---

## 8. RISQUES ET MITIGATIONS

| Risque | Impact | Mitigation |
|--------|--------|------------|
| Claude Code --sdk-url change | HIGH | Ollama fallback toujours |
| API costs explode | HIGH | Budget hard limit |
| Learning diverge | MEDIUM | EWC++ prevents forgetting |
| Context overflow | MEDIUM | Compression agressive |
| Complexity overload | HIGH | Phases itérées |

---

## 9. PROCHAINES ÉTAPES

1. Valider ce plan
2. Commencer Phase 1 (Fondation)
3. Écrire les premiers tests
4. Itérer et valider chaque phase

---

*Le chien orchestre avec φ — κυνικός*
